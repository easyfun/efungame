#任务调度系统

##第一章 功能
高稳定，高可靠，高性能

##第二章 工作原理
高性能: 尽量少与db交互，尽量少交互信息量，批量查询

基于redis、mysql

##第三章 数据结构
task: {childTask1,childTask2,...}
taskHandler: {childTaskHandler1,childTaskHandler2,...}

###mysql表设计
create database task;
use task;
create table t_task (
  id                bigint not null comment '任务id',
  handler           varchar(128) not null default '' comment '任务处理器',#逻辑可变
  param             varchar(128) not null default '' comment '请求参数',
  status            varchar(16) not null default '' comment '处理状态',
  ###version           varchar(16) not null default '0.0.0' comment '处理器版本号',
  ###child_task        varchar(512) not null default '' comment '子任务',#列表可变
  retry_strategy  tinyint not null default '1' comment '重试策略',
  retry_interval  int not null default '60' comment '重试时间间隔:豪秒',
  max_retry_time  int not null default '0' comment '最大重试次数',
  next_time         datetime not null default '0000-00-00 00:00:00' comment '下次执行时间',
  last_time         datetime not null default '0000-00-00 00:00:00' comment '最新执行时间',
  first_time        datetime not null default '0000-00-00 00:00:00' comment '首次执行时间',
  primary key (id),
  index index_next_time (next_time),
  index index_last_time (last_time),
  index index_first_time (first_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 comment '任务信息表';

create table t_child_task (
  id                bigint not null comment '任务id',
  child_handler     varchar(128) not null default '' comment '子任务处理器',#逻辑可变
  handler           varchar(128) not null default '' comment '任务处理器',#逻辑可变
  status            varchar(16) not null default '' comment '处理状态',
  last_time         datetime not null default '0000-00-00 00:00:00' comment '最新执行时间',
  first_time        datetime not null default '0000-00-00 00:00:00' comment '首次执行时间',
  primary key (id),
  index index_last_time (last_time),
  index index_first_time (first_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 comment '子任务信息表';

###redis数据结构
####任务信息
采用方案一

方案一
t_task:$id
    handler
    param
    status
    retry_strategy
    retry_interval
    next_time
    last_time
    first_time

方案二
t_task
    $id {"handler":"","param":"","status":"","retryStrategy":"","retryInterval":"","nextTime":"","lastTime":"","firstTime":""}


####子任务信息
采用方案二，检查子任务状态

方案一
t_child_task:$id:$child_handler
    handler
    status
    last_time
    first_time

方案二
t_child_task:$id
    $child_handler:handler
    $child_handler:status
    $child_handler:last_time
    $child_handler:first_time

方案三
t_child_task:$id
    $child_handler {"handler":"","status":"","lastTime":"","firstTime":""}


###处理队列
日集合,
执行队列,zset,runningQueue:{id1,id2,...}
等待队列,zset,waitingQueue:{id1,id2,...}
成功集合,set,sucessList:{id1,id2,...}
失败集合,set,failList:{id2,id2,...}

###任务并发策略:
同一个任务,只能由一个线程执行,不可以同时被多个线程执行
id唯一,已经存在的,不可以再插入
params唯一,已经存在的,不可以再插入

###任务重启策略:
成功的不可以重启
(#失败的不可以重启)
处理中的不可以重启
丢失的可以重启

###任务重试策略:
等时重试n次;
指数间隔重试n次;
前3次等时后指数间隔一共重试n次;
无限重试;
首日重试n次，次日重试n次;

###任务状态:
success
fail
failretry
pause
pausequit


##第四章 任务生产

##第五章 任务消费

##第六章 任务清理

##第七章 任务管理系统
